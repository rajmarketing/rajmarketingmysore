<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Raj Marketing Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;900&family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    /* ... (Styles same as previous, omitted for brevity) ... */
    /* Use your full existing CSS from the previous admin.html */
  </style>
</head>
<body>
<!-- Modal for password -->
<div class="modal-bg" id="adminModal">
  <div class="modal-box">
    <div class="modal-title">Admin Login</div>
    <form id="adminLoginForm" autocomplete="off">
      <input type="password" id="adminPassword" placeholder="Enter Admin Password" required autofocus>
      <br>
      <button type="submit">Access Admin</button>
      <div class="modal-error" id="modalError"></div>
    </form>
  </div>
</div>
<div class="admin-header">
  <button class="menu-toggle" aria-label="Open menu"><i class="fa-solid fa-bars"></i></button>
  <span><i class="fa-solid fa-shield-halved"></i> Raj Marketing Admin</span>
</div>
<div class="menu-overlay"></div>
<div class="admin-layout">
  <nav class="admin-menu" id="adminMenu">
    <a data-page="dashboard" class="active"><i class="fa-solid fa-gauge"></i> Dashboard</a>
    <a data-page="visitors"><i class="fa-solid fa-users"></i> Visitors</a>
    <a data-page="appointments"><i class="fa-solid fa-calendar-check"></i> Appointments</a>
    <a data-page="estimates"><i class="fa-solid fa-calculator"></i> Estimates</a>
    <a data-page="contacts"><i class="fa-solid fa-envelope"></i> Contacts</a>
    <a data-page="gallery"><i class="fa-solid fa-images"></i> Gallery</a>
    <a data-page="logout" style="color:var(--admin-danger);"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
  </nav>
  <main class="admin-content" id="adminContent"></main>
</div>
<script>
const API = 'http://localhost:4000'; // Adjust as needed
let loggedIn = false;

function showModal(show = true, error = '') {
  document.getElementById('adminModal').style.display = show ? 'flex' : 'none';
  document.getElementById('modalError').textContent = error;
  if (show) document.getElementById('adminPassword').focus();
}

document.getElementById('adminLoginForm').onsubmit = async function(e) {
  e.preventDefault();
  const pw = document.getElementById('adminPassword').value.trim();
  try {
    const res = await fetch(API + '/api/admin-login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ password: pw })
    });
    if (res.ok) {
      loggedIn = true;
      localStorage.setItem('rajmarketing-admin', 'true');
      showModal(false);
      loadPage('dashboard');
    } else {
      document.getElementById('modalError').textContent = 'Incorrect password!';
      document.getElementById('adminPassword').value = '';
      document.getElementById('adminPassword').focus();
    }
  } catch (err) {
    document.getElementById('modalError').textContent = 'Server error. Try again later.';
  }
};

window.onload = function() {
  if (localStorage.getItem('rajmarketing-admin') === 'true') {
    showModal(false);
    loadPage('dashboard');
  } else {
    showModal(true);
  }
};

// --- Menu & Layout (unchanged) ---
const menuToggle = document.querySelector('.menu-toggle');
const menu = document.getElementById('adminMenu');
const overlay = document.querySelector('.menu-overlay');
menuToggle.addEventListener('click', function(e){
  if (menu.classList.contains('open')) closeMenu();
  else openMenu();
});
overlay.addEventListener('click', closeMenu);
function openMenu() {
  menu.classList.add('open', 'mobile');
  overlay.classList.add('show');
  document.body.style.overflow = 'hidden';
}
function closeMenu() {
  menu.classList.remove('open', 'mobile');
  overlay.classList.remove('show');
  document.body.style.overflow = '';
}

// --- Admin Pages ---
const pages = {
  dashboard: `
    <div class="admin-title">Welcome to Admin Dashboard</div>
    <div class="admin-card">
      <ul style="line-height:1.7; color:#1976d2; font-size:1.09rem;">
        <li>Live visitor tracking and analytics</li>
        <li>Manage appointments, estimates, contacts</li>
        <li>Upload and organize gallery images (instantly update home page)</li>
      </ul>
    </div>
  `,
  visitors: `
    <div class="admin-title">Live Visitor Tracker</div>
    <div class="admin-card">
      <table style="width:100%;" class="admin-table">
        <thead>
          <tr><th>Date & Time</th><th>IP / Location</th><th>Page Visited</th></tr>
        </thead>
        <tbody id="visitorsTable"></tbody>
      </table>
      <div id="noVisitors" style="color:#777; margin-top: 10px; display:none;">No visitors yet.</div>
    </div>
  `,
  appointments: `
    <div class="admin-title">Appointments</div>
    <div class="admin-card">
      <table style="width:100%;" class="admin-table">
        <thead>
          <tr><th>Date</th><th>Name</th><th>Status</th></tr>
        </thead>
        <tbody id="apptTable"></tbody>
      </table>
      <div id="noAppt" style="color:#777; margin-top: 10px; display:none;">No appointments yet.</div>
    </div>
  `,
  estimates: `
    <div class="admin-title">Customer Estimates</div>
    <div class="admin-card">
      <table style="width:100%;" class="admin-table">
        <thead>
          <tr><th>Date</th><th>Name</th><th>Details</th></tr>
        </thead>
        <tbody id="estTable"></tbody>
      </table>
      <div id="noEst" style="color:#777; margin-top: 10px; display:none;">No estimates yet.</div>
    </div>
  `,
  contacts: `
    <div class="admin-title">Contact Form Reports</div>
    <div class="admin-card">
      <table style="width:100%;" class="admin-table">
        <thead>
          <tr><th>Date</th><th>Name</th><th>Email</th><th>Message</th></tr>
        </thead>
        <tbody id="contactTable"></tbody>
      </table>
      <div id="noContact" style="color:#777; margin-top: 10px; display:none;">No contact messages yet.</div>
    </div>
  `,
  gallery: `
    <div class="admin-title">Gallery Manager</div>
    <div class="admin-card">
      <form id="galleryUploadForm" class="gallery-upload">
        <input type="file" id="galleryInput" accept="image/*" multiple hidden>
        <span id="galleryUploadText"><i class="fa-solid fa-cloud-arrow-up"></i> Drag & Drop or Click to Upload Images</span>
      </form>
      <div class="gallery-grid" id="galleryGrid"></div>
    </div>
  `,
  logout: `<div class="admin-card"><div class="admin-title" style="color:var(--admin-danger);">You have been logged out.</div><p>Return to the login screen to re-enter admin password.</p></div>`
};

document.getElementById('adminMenu').addEventListener('click', async function(e) {
  if (e.target.closest('a')) {
    const a = e.target.closest('a');
    const page = a.getAttribute('data-page');
    [...this.querySelectorAll('a')].forEach(a => a.classList.remove('active'));
    a.classList.add('active');
    if (page === 'logout') {
      await fetch(API + '/api/admin-logout', { method: 'POST', credentials: 'include' });
      localStorage.removeItem('rajmarketing-admin');
      showModal(true, 'Logged out.');
      document.getElementById('adminContent').innerHTML = pages.logout;
      closeMenu();
    } else if (pages[page]) {
      loadPage(page);
      closeMenu();
    }
  }
});
function loadPage(page) {
  document.getElementById('adminContent').innerHTML = pages[page] || '';
  if (page === 'visitors') loadVisitors();
  if (page === 'appointments') loadAppointments();
  if (page === 'estimates') loadEstimates();
  if (page === 'contacts') loadContacts();
  if (page === 'gallery') setupGallery();
}

function loadVisitors() {
  fetch(API + '/api/visitors', { credentials: 'include' })
    .then(r=>r.json()).then(visitors=>{
      const tbody = document.getElementById('visitorsTable');
      tbody.innerHTML = '';
      if (!visitors.length) document.getElementById('noVisitors').style.display = 'block';
      else document.getElementById('noVisitors').style.display = 'none';
      visitors.forEach(v => {
        tbody.innerHTML += `<tr><td>${v.date.replace('T',' ').slice(0,16)}</td><td>${v.ip||'-'}</td><td>${v.page}</td></tr>`;
      });
    }).catch(() => {
      document.getElementById('noVisitors').style.display = 'block';
      document.getElementById('noVisitors').textContent = 'Could not load visitors (API error).';
    });
}
function loadAppointments() {
  fetch(API + '/api/appointments', { credentials: 'include' })
    .then(r=>r.json()).then(appts=>{
      const tbody = document.getElementById('apptTable');
      tbody.innerHTML = '';
      if (!appts.length) document.getElementById('noAppt').style.display = 'block';
      else document.getElementById('noAppt').style.display = 'none';
      appts.forEach(a => {
        tbody.innerHTML += `<tr><td>${a.date}</td><td>${a.name}</td><td>${a.status}</td></tr>`;
      });
    }).catch(() => {
      document.getElementById('noAppt').style.display = 'block';
      document.getElementById('noAppt').textContent = 'Could not load appointments (API error).';
    });
}
function loadEstimates() {
  fetch(API + '/api/estimates', { credentials: 'include' })
    .then(r=>r.json()).then(ests=>{
      const tbody = document.getElementById('estTable');
      tbody.innerHTML = '';
      if (!ests.length) document.getElementById('noEst').style.display = 'block';
      else document.getElementById('noEst').style.display = 'none';
      ests.forEach(e => {
        tbody.innerHTML += `<tr><td>${e.date}</td><td>${e.name}</td><td>${e.details}</td></tr>`;
      });
    }).catch(() => {
      document.getElementById('noEst').style.display = 'block';
      document.getElementById('noEst').textContent = 'Could not load estimates (API error).';
    });
}
function loadContacts() {
  fetch(API + '/api/contacts', { credentials: 'include' })
    .then(r=>r.json()).then(contacts=>{
      const tbody = document.getElementById('contactTable');
      tbody.innerHTML = '';
      if (!contacts.length) document.getElementById('noContact').style.display = 'block';
      else document.getElementById('noContact').style.display = 'none';
      contacts.forEach(c => {
        tbody.innerHTML += `<tr><td>${c.date}</td><td>${c.name}</td><td>${c.email}</td><td>${c.message}</td></tr>`;
      });
    }).catch(() => {
      document.getElementById('noContact').style.display = 'block';
      document.getElementById('noContact').textContent = 'Could not load contacts (API error).';
    });
}
function setupGallery() {
  fetch(API + '/api/gallery', { credentials: 'include' })
    .then(r=>r.json()).then(renderGallery);

  function renderGallery(galleryImgs) {
    const grid = document.getElementById('galleryGrid');
    grid.innerHTML = '';
    if (!galleryImgs.length) {
      grid.innerHTML = '<div style="color:#888;text-align:center;padding:20px 0;">No images in gallery yet.</div>';
    } else {
      galleryImgs.forEach((img,i) => {
        grid.innerHTML += `<div class="gallery-thumb" data-idx="${i}" tabindex="0">
          <img src="${API}${img.url}" alt="Gallery ${i+1}">
        </div>`;
      });
    }
  }
  const uploadForm = document.getElementById('galleryUploadForm');
  const uploadInput = document.getElementById('galleryInput');
  uploadForm.onclick = () => uploadInput.click();
  uploadForm.ondragover = e => { e.preventDefault(); uploadForm.classList.add('dragover'); };
  uploadForm.ondragleave = e => { uploadForm.classList.remove('dragover'); };
  uploadForm.ondrop = function(e) {
    e.preventDefault();
    uploadForm.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
  };
  uploadInput.onchange = () => handleFiles(uploadInput.files);
  function handleFiles(files) {
    const formData = new FormData();
    Array.from(files).forEach(f=>formData.append('images', f));
    fetch(API + '/api/gallery/upload', {
      method: 'POST',
      credentials: 'include',
      body: formData
    }).then(r=>r.json()).then(res => {
      renderGallery(res.gallery);
    });
    uploadInput.value = "";
  }
}

document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  if ((e.ctrlKey && e.key === 'u') || (e.ctrlKey && e.key === 's') || (e.ctrlKey && e.key === 'c')) {
    e.preventDefault();
  }
});
function checkAdmin() {
  if (!loggedIn && localStorage.getItem('rajmarketing-admin') !== 'true') {
    showModal(true);
    document.querySelector('.admin-header').style.filter = "blur(3px)";
    document.querySelector('.admin-content').style.filter = "blur(7px)";
  } else {
    showModal(false);
    document.querySelector('.admin-header').style.filter = "";
    document.querySelector('.admin-content').style.filter = "";
  }
}
setInterval(checkAdmin, 1000);
</script>
</body>
</html>
